services:
  # Active Directory Domain Controller
  domain-controller:
    build:
      context: .
      dockerfile: Dockerfile.dc
    container_name: ga-applocker-dc
    hostname: DC01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME:-applocker.local}
      - DOMAIN_NETBIOS=${DOMAIN_NETBIOS:-APPLOCKER}
      - DOMAIN_ADMIN_PASSWORD=${DOMAIN_ADMIN_PASSWORD:?DOMAIN_ADMIN_PASSWORD is required - see .env.example}
      - DNS_FORWARDER=${DNS_FORWARDER:-8.8.8.8}
      - SAFE_MODE_PASSWORD=${SAFE_MODE_PASSWORD:?SAFE_MODE_PASSWORD is required - see .env.example}
    volumes:
      - dc-data:/var/lib/samba
      - dc-config:/etc/samba
      - ./scripts:/scripts:ro
    ports:
      - "53:53/udp"
      - "53:53/tcp"
      - "88:88/udp"
      - "88:88/tcp"
      - "135:135/tcp"
      - "389:389/tcp"
      - "389:389/udp"
      - "445:445/tcp"
      - "464:464/tcp"
      - "636:636/tcp"
      - "3268:3268/tcp"
      - "3269:3269/tcp"
    restart: unless-stopped
    command: /bin/sh -c "chmod +x /scripts/setup-dc.sh && /scripts/setup-dc.sh"

  # Windows Client for AppLocker Testing
  windows-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: ga-applocker-client
    hostname: CLIENT01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME:-applocker.local}
      - DOMAIN_ADMIN_USER=Administrator
      - DOMAIN_ADMIN_PASSWORD=${DOMAIN_ADMIN_PASSWORD:?DOMAIN_ADMIN_PASSWORD is required - see .env.example}
      - DNS_SERVER=domain-controller
    depends_on:
      - domain-controller
    volumes:
      - client-data:/data
      - ./scripts:/scripts:ro
      - ./test-apps:/test-apps:ro
    ports:
      - "5985:5985"  # WinRM HTTP
      - "5986:5986"  # WinRM HTTPS
    restart: unless-stopped
    command: /bin/sh -c "chmod +x /scripts/setup-client.sh && sleep 30 && /scripts/setup-client.sh"

  # Development/Testing Container for the Application
  app-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.app.linux
    container_name: ga-applocker-app
    hostname: APP01
    networks:
      - applocker-network
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DOMAIN_NAME=${DOMAIN_NAME:-applocker.local}
      - DOMAIN_ADMIN_USER=Administrator
      - DOMAIN_ADMIN_PASSWORD=${DOMAIN_ADMIN_PASSWORD:?DOMAIN_ADMIN_PASSWORD is required - see .env.example}
      - DNS_SERVER=domain-controller
    depends_on:
      - domain-controller
      - windows-client
    volumes:
      - ../:/app
      - app-node-modules:/app/node_modules
      - ./scripts:/scripts:ro
    ports:
      - "3000:3000"  # Vite dev server
      - "5173:5173"  # Alternative Vite port
    working_dir: /app
    restart: unless-stopped
    stdin_open: true
    tty: true

networks:
  applocker-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  dc-data:
  dc-config:
  client-data:
  app-node-modules:
