version: '3.8'

# Windows Server 2019 Docker Compose - Expanded Environment
# Includes: Primary DC, Backup DC, Client, and Multiple Member Servers
# Requires: Windows 10/11 Pro/Enterprise or Windows Server 2019+ with Windows containers enabled

services:
  # Primary Windows Server 2019 Domain Controller
  dc-windows2019:
    build:
      context: .
      dockerfile: Dockerfile.windows2019-dc
    image: ga-applocker-dc-windows2019:latest
    container_name: ga-applocker-dc-2019
    hostname: DC01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=applocker.local
      - DOMAIN_NETBIOS=APPLOCKER
      - DOMAIN_ADMIN_PASSWORD=SecurePass123!
      - SAFE_MODE_PASSWORD=SafeMode123!
      - DNS_FORWARDER=8.8.8.8
    volumes:
      - dc-data-2019:C:\Windows\NTDS
      - dc-sysvol-2019:C:\Windows\SYSVOL
      - dc-logs-2019:C:\logs
      - ./scripts:C:\scripts:ro
      - ./test-results:C:\test-results
    ports:
      - "53:53/udp"
      - "53:53/tcp"
      - "88:88/udp"
      - "88:88/tcp"
      - "135:135/tcp"
      - "389:389/tcp"
      - "389:389/udp"
      - "445:445/tcp"
      - "464:464/tcp"
      - "636:636/tcp"
      - "3268:3268/tcp"
      - "3269:3269/tcp"
    restart: unless-stopped
    command: powershell -Command "Start-Sleep -Seconds 10; C:\scripts\setup-dc-windows.ps1; C:\scripts\create-users-and-groups.ps1; while ($true) { Start-Sleep -Seconds 3600 }"

  # Backup Windows Server 2019 Domain Controller
  backup-dc-windows2019:
    build:
      context: .
      dockerfile: Dockerfile.windows2019-backup-dc
    image: ga-applocker-backup-dc-windows2019:latest
    container_name: ga-applocker-backup-dc-2019
    hostname: DC02
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=applocker.local
      - DOMAIN_NETBIOS=APPLOCKER
      - DOMAIN_ADMIN_PASSWORD=SecurePass123!
      - SAFE_MODE_PASSWORD=SafeMode123!
      - PRIMARY_DC=DC01
    depends_on:
      - dc-windows2019
    volumes:
      - backup-dc-data-2019:C:\Windows\NTDS
      - backup-dc-sysvol-2019:C:\Windows\SYSVOL
      - backup-dc-logs-2019:C:\logs
      - ./scripts:C:\scripts:ro
      - ./test-results:C:\test-results
    ports:
      - "5353:53/udp"
      - "5353:53/tcp"
      - "8888:88/udp"
      - "8888:88/tcp"
    restart: unless-stopped
    command: powershell -Command "Start-Sleep -Seconds 180; C:\scripts\setup-backup-dc-windows.ps1; while ($true) { Start-Sleep -Seconds 3600 }"

  # Windows Server 2019 Client with AppLocker
  client-windows2019:
    build:
      context: .
      dockerfile: Dockerfile.windows2019-client
    image: ga-applocker-client-windows2019:latest
    container_name: ga-applocker-client-2019
    hostname: CLIENT01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=applocker.local
      - DOMAIN_ADMIN_USER=Administrator
      - DOMAIN_ADMIN_PASSWORD=SecurePass123!
      - DNS_SERVER=dc-windows2019
      - BACKUP_DNS_SERVER=backup-dc-windows2019
      - DC_HOSTNAME=DC01
    depends_on:
      - dc-windows2019
      - backup-dc-windows2019
    volumes:
      - client-data-2019:C:\Data
      - client-logs-2019:C:\logs
      - ./scripts:C:\scripts:ro
      - ./test-apps:C:\test-apps:ro
      - ./test-results:C:\test-results
    ports:
      - "5985:5985"  # WinRM HTTP
      - "5986:5986"  # WinRM HTTPS
    restart: unless-stopped
    command: powershell -Command "Start-Sleep -Seconds 240; C:\scripts\setup-client-windows.ps1; C:\scripts\run-functionality-tests.ps1"

  # Member Server 1 - File Server
  member-server-01:
    build:
      context: .
      dockerfile: Dockerfile.windows2019-member
    image: ga-applocker-member-windows2019:latest
    container_name: ga-applocker-member-01-2019
    hostname: FILESERVER01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=applocker.local
      - DOMAIN_ADMIN_USER=Administrator
      - DOMAIN_ADMIN_PASSWORD=SecurePass123!
      - DNS_SERVER=dc-windows2019
      - BACKUP_DNS_SERVER=backup-dc-windows2019
      - SERVER_ROLE=FileServer
    depends_on:
      - dc-windows2019
      - backup-dc-windows2019
    volumes:
      - member01-data-2019:C:\Data
      - member01-logs-2019:C:\logs
      - ./scripts:C:\scripts:ro
      - ./test-apps:C:\test-apps:ro
      - ./test-results:C:\test-results
    ports:
      - "5987:5985"  # WinRM HTTP
      - "5988:5986"  # WinRM HTTPS
    restart: unless-stopped
    command: powershell -Command "Start-Sleep -Seconds 240; C:\scripts\setup-member-server-windows.ps1"

  # Member Server 2 - Application Server
  member-server-02:
    build:
      context: .
      dockerfile: Dockerfile.windows2019-member
    image: ga-applocker-member-windows2019:latest
    container_name: ga-applocker-member-02-2019
    hostname: APPSERVER01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=applocker.local
      - DOMAIN_ADMIN_USER=Administrator
      - DOMAIN_ADMIN_PASSWORD=SecurePass123!
      - DNS_SERVER=dc-windows2019
      - BACKUP_DNS_SERVER=backup-dc-windows2019
      - SERVER_ROLE=AppServer
    depends_on:
      - dc-windows2019
      - backup-dc-windows2019
    volumes:
      - member02-data-2019:C:\Data
      - member02-logs-2019:C:\logs
      - ./scripts:C:\scripts:ro
      - ./test-apps:C:\test-apps:ro
      - ./test-results:C:\test-results
    ports:
      - "5989:5985"  # WinRM HTTP
      - "5990:5986"  # WinRM HTTPS
    restart: unless-stopped
    command: powershell -Command "Start-Sleep -Seconds 240; C:\scripts\setup-member-server-windows.ps1"

  # Member Server 3 - Web Server
  member-server-03:
    build:
      context: .
      dockerfile: Dockerfile.windows2019-member
    image: ga-applocker-member-windows2019:latest
    container_name: ga-applocker-member-03-2019
    hostname: WEBSERVER01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=applocker.local
      - DOMAIN_ADMIN_USER=Administrator
      - DOMAIN_ADMIN_PASSWORD=SecurePass123!
      - DNS_SERVER=dc-windows2019
      - BACKUP_DNS_SERVER=backup-dc-windows2019
      - SERVER_ROLE=WebServer
    depends_on:
      - dc-windows2019
      - backup-dc-windows2019
    volumes:
      - member03-data-2019:C:\Data
      - member03-logs-2019:C:\logs
      - ./scripts:C:\scripts:ro
      - ./test-apps:C:\test-apps:ro
      - ./test-results:C:\test-results
    ports:
      - "5991:5985"  # WinRM HTTP
      - "5992:5986"  # WinRM HTTPS
    restart: unless-stopped
    command: powershell -Command "Start-Sleep -Seconds 240; C:\scripts\setup-member-server-windows.ps1"

  # Member Server 4 - Database Server
  member-server-04:
    build:
      context: .
      dockerfile: Dockerfile.windows2019-member
    image: ga-applocker-member-windows2019:latest
    container_name: ga-applocker-member-04-2019
    hostname: DBSERVER01
    networks:
      - applocker-network
    environment:
      - DOMAIN_NAME=applocker.local
      - DOMAIN_ADMIN_USER=Administrator
      - DOMAIN_ADMIN_PASSWORD=SecurePass123!
      - DNS_SERVER=dc-windows2019
      - BACKUP_DNS_SERVER=backup-dc-windows2019
      - SERVER_ROLE=DatabaseServer
    depends_on:
      - dc-windows2019
      - backup-dc-windows2019
    volumes:
      - member04-data-2019:C:\Data
      - member04-logs-2019:C:\logs
      - ./scripts:C:\scripts:ro
      - ./test-apps:C:\test-apps:ro
      - ./test-results:C:\test-results
    ports:
      - "5993:5985"  # WinRM HTTP
      - "5994:5986"  # WinRM HTTPS
    restart: unless-stopped
    command: powershell -Command "Start-Sleep -Seconds 240; C:\scripts\setup-member-server-windows.ps1"

networks:
  applocker-network:
    driver: nat
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  dc-data-2019:
  dc-sysvol-2019:
  dc-logs-2019:
  backup-dc-data-2019:
  backup-dc-sysvol-2019:
  backup-dc-logs-2019:
  client-data-2019:
  client-logs-2019:
  member01-data-2019:
  member01-logs-2019:
  member02-data-2019:
  member02-logs-2019:
  member03-data-2019:
  member03-logs-2019:
  member04-data-2019:
  member04-logs-2019:
